#!/bin/bash
# shellcheck disable=SC2154
set -e
# Variables inyectadas por Terraform:
# - cluster_name
# - region
# - vpc_id
# - aws_alb_iam_role
# - argocd_role_arn

CLUSTER_NAME=${cluster_name}
AWS_REGION=${region}
VPC_ID=${vpc_id}
AWS_ALB_IAM_ROLE=${aws_alb_iam_role}
ARGOCD_ROLE_ARN=${argocd_role_arn}
SCRIPT_DIR="$(cd "$(dirname "$${BASH_SOURCE[0]}")" && pwd)"
K8s_FIXED_SCRIPTS_DIR=$(cd $SCRIPT_DIR/../../k8s_fixed_scripts && pwd)

echo "script dir $SCRIPT_DIR"
if [ -z "$CLUSTER_NAME" ] || [ -z $AWS_REGION ]; then
    echo "Usage: needs Cluster name and region"
    exit 1
fi

echo "Configuring kubeconfig for cluster $CLUSTER_NAME in region $AWS_REGION"
aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_REGION  \
  --kubeconfig ~/.kube/config

helm repo add eks https://aws.github.io/eks-charts
helm repo update

ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
CONTEXT_ARN="arn:aws:eks:$AWS_REGION:$ACCOUNT_ID:cluster/$CLUSTER_NAME"

echo "Using context ARN: $CONTEXT_ARN"
kubectl config use-context $CONTEXT_ARN

echo "Installing ALB Controller in $CLUSTER_NAME with role $AWS_ALB_IAM_ROLE in region $AWS_REGION and VPC $VPC_ID ..."
echo "Using IAM role for AWS Loazd Balancer Controller with name: $AWS_ALB_IAM_ROLE"
echo "Installing AWS Load Balancer Controller via Helm"
chmod +x "$K8s_FIXED_SCRIPTS_DIR/install-aws-alb.sh"
bash "$K8s_FIXED_SCRIPTS_DIR/install-aws-alb.sh"


echo "Esperamos a que se configure ALB Controller"
kubectl wait --for=condition=available deployment/aws-load-balancer-controller \
  -n kube-system --timeout=120s

chmod +x "$K8s_FIXED_SCRIPTS_DIR/Applying-k8s-manifests.sh"
bash "$K8s_FIXED_SCRIPTS_DIR/Applying-k8s-manifests.sh"

echo "Installing ArgoCD"
chmod +x "$K8s_FIXED_SCRIPTS_DIR/install-argocd.sh"
bash "$K8s_FIXED_SCRIPTS_DIR/install-argocd.sh" $ARGOCD_ROLE_ARN
